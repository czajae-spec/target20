<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace 3E: Target 20</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            margin: 0;
            padding: 20px;
            max-width: 1400px;
            margin: auto;
        }
        #title {
            font-size: 2.5em;
            text-align: center;
            color: #007bff;
            margin-bottom: 10px;
        }
        #controls {
            text-align: center;
            margin-bottom: 20px;
        }
        #controls button {
            font-size: 1.2em;
            padding: 10px 20px;
            margin: 0 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #controls button:hover {
            background: #218838;
        }
        #game {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: start;
        }
        .player-area {
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .player-area h2 {
            text-align: center;
            color: #007bff;
        }
        #center {
            text-align: center;
        }
        #deck {
            font-size: 1.5em;
            color: #666;
            margin-bottom: 10px;
        }
        #draw-btn {
            font-size: 1.5em;
            padding: 15px 30px;
            background: #ffc107;
            color: #333;
            border: 2px solid #ffc107;
            border-radius: 10px;
            cursor: pointer;
            display: none;
        }
        #draw-btn:hover {
            background: #e0a800;
        }
        #discard {
            width: 80px;
            height: 120px;
            margin: 10px auto;
            border: 2px dashed #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: #999;
        }
        #round, #status {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
            min-height: 30px;
        }
        #status {
            color: #007bff;
            font-size: 1.3em;
        }
        .hand {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            min-height: 140px;
        }
        .card {
            width: 80px;
            height: 120px;
            border: 3px solid #333;
            border-radius: 10px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            user-select: none;
        }
        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .card.selected {
            border-color: #28a745;
            background: #d4edda;
            box-shadow: 0 0 15px #28a745;
        }
        .card.other-hand {
            opacity: 0.5;
            cursor: default;
        }
        .card.other-hand:hover {
            transform: none;
            box-shadow: none;
        }
        #selection-area {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 10px;
            display: none;
        }
        #selection-area h3 {
            margin-top: 0;
        }
        .selected-item {
            display: inline-flex;
            align-items: center;
            margin: 5px;
        }
        .wild-input {
            width: 50px;
            margin-left: 5px;
            padding: 5px;
            font-size: 1.2em;
        }
        #sum-input {
            font-size: 1.5em;
            padding: 10px;
            width: 100px;
            margin: 10px 0;
        }
        .action-btn {
            font-size: 1.2em;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-proceed { background: #28a745; color: white; }
        .btn-proceed:hover { background: #218838; }
        .btn-correct { background: #28a745; color: white; }
        .btn-incorrect { background: #dc3545; color: white; }
        .btn-back { background: #6c757d; color: white; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background: #007bff;
            color: white;
        }
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            border-radius: 10px;
            position: relative;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
        }
        #game-over {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 2em;
            color: #28a745;
            display: none;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="title">Workplace 3E: Target 20</div>
    <div id="controls">
        <button id="instructions-btn">How to Play</button>
        <label><input type="checkbox" id="wild-toggle"> Variation A: Use Wild Cards</label>
        <button id="new-game">New Game</button>
    </div>
    <div id="game">
        <div id="player1" class="player-area">
            <h2>Player 1</h2>
            <div id="p1-hand" class="hand"></div>
            <div id="p1-selection" id="selection-area"></div>
            <div id="p1-sheet"></div>
        </div>
        <div id="center">
            <div id="deck">Deck: 0 cards</div>
            <button id="draw-btn">Draw Card</button>
            <div id="discard">Discard</div>
            <div id="round"></div>
            <div id="status"></div>
            <div id="game-over"></div>
        </div>
        <div id="player2" class="player-area">
            <h2>Player 2</h2>
            <div id="p2-hand" class="hand"></div>
            <div id="p2-selection" id="selection-area"></div>
            <div id="p2-sheet"></div>
        </div>
    </div>
    <div id="modal">
        <div id="modal-content">
            <span class="close">&times;</span>
            <div id="instructions-text"></div>
        </div>
    </div>

    <script>
        class TargetTwentyGame {
            constructor() {
                this.deck = [];
                this.discard = [];
                this.hands = { p1: [], p2: [] };
                this.selected = { p1: [], p2: [] };
                this.sheets = { p1: [], p2: [] };
                this.round = 1;
                this.phase = 'init';
                this.currentPlayer = 'p1';
                this.selectingPlayer = null;
                this.enteredSum = 0;
                this.useWild = false;
                this.initElements();
                this.newGame();
            }

            initElements() {
                this.elements = {
                    drawBtn: document.getElementById('draw-btn'),
                    status: document.getElementById('status'),
                    roundEl: document.getElementById('round'),
                    deckEl: document.getElementById('deck'),
                    p1Hand: document.getElementById('p1-hand'),
                    p2Hand: document.getElementById('p2-hand'),
                    p1Sheet: document.getElementById('p1-sheet'),
                    p2Sheet: document.getElementById('p2-sheet'),
                    gameOver: document.getElementById('game-over')
                };
            }

            newGame() {
                this.useWild = document.getElementById('wild-toggle').checked;
                this.deck = [];
                for (let n = 0; n <= 10; n++) {
                    for (let i = 0; i < 12; i++) {
                        this.deck.push({ num: n });
                    }
                }
                if (this.useWild) {
                    for (let i = 0; i < 12; i++) {
                        this.deck.push({ num: 'W' });
                    }
                }
                this.shuffle(this.deck);
                this.discard = [];
                this.hands = { p1: [], p2: [] };
                this.selected = { p1: [], p2: [] };
                this.sheets = { p1: new Array(5).fill(null), p2: new Array(5).fill(null) };
                this.round = 1;
                this.phase = 'drawing';
                this.currentPlayer = 'p1';
                this.selectingPlayer = null;
                this.enteredSum = 0;
                this.updateUI();
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            drawCard() {
                if (this.deck.length === 0) {
                    if (this.discard.length === 0) {
                        alert('No cards left!');
                        return;
                    }
                    this.deck = [...this.discard];
                    this.discard = [];
                    this.shuffle(this.deck);
                }
                const card = this.deck.pop();
                this.hands[this.currentPlayer].push(card);
                this.updateUI();
                this.switchCurrentPlayer();
                if (this.hands.p1.length >= 5 && this.hands.p2.length >= 5) {
                    this.phase = 'selecting_p1';
                    this.updateUI();
                }
            }

            switchCurrentPlayer() {
                this.currentPlayer = this.currentPlayer === 'p1' ? 'p2' : 'p1';
            }

            toggleSelect(player, handIdx) {
                if (this.phase !== `selecting_${player}`) return;
                const idx = this.selected[player].indexOf(handIdx);
                if (idx > -1) {
                    this.selected[player].splice(idx, 1);
                } else {
                    if (this.selected[player].length < 3) {
                        this.selected[player].push(handIdx);
                    }
                }
                this.updateUI();
            }

            proceedToEnter(player) {
                if (this.selected[player].length !== 3) return;
                this.selectingPlayer = player;
                this.phase = `entering_${player}`;
                this.updateUI();
            }

            submitSum() {
                const player = this.selectingPlayer;
                this.enteredSum = parseInt(document.getElementById('sum-input').value);
                if (isNaN(this.enteredSum) || this.enteredSum < 0) {
                    alert('Please enter a valid sum.');
                    return;
                }
                // Check all wilds assigned
                let unassigned = false;
                for (let hidx of this.selected[player]) {
                    const card = this.hands[player][hidx];
                    if (card.num === 'W' && card.wildValue === undefined) {
                        unassigned = true;
                        break;
                    }
                }
                if (unassigned) {
                    alert('Please assign values to all wild cards (1-9).');
                    return;
                }
                this.phase = `checking_${player}`;
                this.updateUI();
            }

            checkSum(isCorrect) {
                const player = this.selectingPlayer;
                if (isCorrect) {
                    // Compute score
                    let actualSum = 0;
                    for (let hidx of this.selected[player]) {
                        const card = this.hands[player][hidx];
                        actualSum += card.num === 'W' ? card.wildValue : card.num;
                    }
                    // Note: we trust the enteredSum as per game, but could verify here if wanted
                    const score = Math.abs(this.enteredSum - 20);
                    const eq = this.makeEquation(player);
                    this.sheets[player][this.round - 1] = {
                        equation: eq,
                        sum: this.enteredSum,
                        score: score,
                        partner: 0
                    };
                    // Clear selected and wildValues for discarded cards
                    for (let hidx of this.selected[player]) {
                        const card = this.hands[player][hidx];
                        if (card.num === 'W') delete card.wildValue;
                    }
                    if (player === 'p1') {
                        this.phase = 'selecting_p2';
                    } else {
                        this.completeRound();
                    }
                } else {
                    this.phase = `entering_${player}`;
                    alert('Sum is incorrect. Player, try entering the sum again.');
                }
                this.updateUI();
            }

            completeRound() {
                // Fill partner scores
                const p1Score = this.sheets.p1[this.round - 1].score;
                const p2Score = this.sheets.p2[this.round - 1].score;
                this.sheets.p1[this.round - 1].partner = p2Score;
                this.sheets.p2[this.round - 1].partner = p1Score;
                // Discard selected cards
                ['p1', 'p2'].forEach(p => {
                    const discardThese = this.selected[p].map(idx => this.hands[p][idx]);
                    this.discard.push(...discardThese);
                    // Remove from hand
                    this.selected[p].sort((a, b) => b - a); // reverse to splice correctly
                    this.selected[p].forEach(idx => this.hands[p].splice(idx, 1));
                    this.selected[p] = [];
                });
                this.round++;
                if (this.round > 5) {
                    this.phase = 'game_over';
                } else {
                    this.phase = 'drawing';
                    this.currentPlayer = 'p1';
                }
                this.updateUI();
            }

            makeEquation(player) {
                const cards = this.selected[player].map(idx => this.hands[player][idx]);
                const displayStrs = cards.map(c => c.num === 'W' ? `*${c.wildValue}` : `${c.num}`);
                displayStrs.sort((a, b) => {
                    const na = parseInt(a.replace('*', ''));
                    const nb = parseInt(b.replace('*', ''));
                    return na - nb;
                });
                return displayStrs.join(' + ') + ' = ' + this.enteredSum;
            }

            updateUI() {
                this.renderDeck();
                this.renderHands();
                this.renderSheets();
                this.elements.drawBtn.style.display = this.phase === 'drawing' ? 'block' : 'none';
                this.elements.drawBtn.onclick = () => this.drawCard();
                this.renderStatus();
                if (this.phase === 'game_over') {
                    this.showGameOver();
                }
            }

            renderDeck() {
                this.elements.deckEl.textContent = `Deck: ${this.deck.length} cards`;
            }

            renderHands() {
                ['p1', 'p2'].forEach(player => {
                    const handEl = document.getElementById(`${player}-hand`);
                    handEl.innerHTML = '';
                    this.hands[player].forEach((card, idx) => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'card';
                        cardDiv.textContent = card.num === 'W' ? 'W' : card.num;
                        const isSelectingThis = this.phase === `selecting_${player}`;
                        const isCurrentHand = player === this.currentPlayer || this.phase === 'drawing';
                        if (!isSelectingThis && player !== this.currentPlayer && this.phase !== 'drawing') {
                            cardDiv.classList.add('other-hand');
                        }
                        if (isSelectingThis && this.selected[player].includes(idx)) {
                            cardDiv.classList.add('selected');
                        }
                        if (isSelectingThis) {
                            cardDiv.onclick = () => this.toggleSelect(player, idx);
                        }
                        handEl.appendChild(cardDiv);
                    });
                });
            }

            renderSheets() {
                ['p1', 'p2'].forEach(player => {
                    const sheetEl = document.getElementById(`${player}-sheet`);
                    let html = '<table><tr><th>Round</th><th>Equation</th><th>Sum</th><th>Your Score</th><th>Partner Score</th></tr>';
                    let total = 0;
                    for (let r = 0; r < 5; r++) {
                        const data = this.sheets[player][r];
                        const rowTotal = data ? data.score : 0;
                        total += rowTotal;
                        html += `<tr><td>${r+1}</td><td>${data ? data.equation : ''}</td><td>${data ? data.sum : ''}</td><td>${rowTotal}</td><td>${data ? data.partner : ''}</td></tr>`;
                    }
                    html += `<tr><td>Total</td><td></td><td></td><td><strong>${total}</strong></td><td></td></tr></table>`;
                    sheetEl.innerHTML = html;
                });
            }

            renderStatus() {
                this.elements.roundEl.textContent = `Round ${this.round}`;
                let status = '';
                switch (this.phase) {
                    case 'drawing':
                        status = `${this.getPlayerName(this.currentPlayer)}'s turn to draw a card`;
                        break;
                    case 'selecting_p1':
                        status = 'Player 1: Click 3 cards in your hand';
                        break;
                    case 'selecting_p2':
                        status = 'Player 2: Click 3 cards in your hand';
                        break;
                    case 'entering_p1':
                        status = 'Player 1: Enter your sum and assign wild values if any';
                        break;
                    case 'entering_p2':
                        status = 'Player 2: Enter your sum and assign wild values if any';
                        break;
                    case 'checking_p1':
                        status = 'Player 2: Check Player 1\'s sum';
                        break;
                    case 'checking_p2':
                        status = 'Player 1: Check Player 2\'s sum';
                        break;
                    case 'game_over':
                        status = '';
                        break;
                }
                this.elements.status.textContent = status;
                this.renderSelectionArea();
                this.renderActionButtons();
            }

            getPlayerName(p) {
                return p === 'p1' ? 'Player 1' : 'Player 2';
            }

            renderSelectionArea() {
                const player = this.selectingPlayer;
                if (!player) return;
                const selEl = document.getElementById(`${player}-selection`);
                ['p1', 'p2'].forEach(p => document.getElementById(`${p}-selection`).style.display = 'none');
                selEl.style.display = 'block';
                const selCardsEl = selEl.querySelector('#selected-cards') || selEl.appendChild(document.createElement('div'));
                selCardsEl.id = 'selected-cards';
                selCardsEl.innerHTML = '<h3>Selected Cards:</h3>';
                const isEntering = this.phase === `entering_${player}`;
                this.selected[player].forEach(handIdx => {
                    const card = this.hands[player][handIdx];
                    const item = document.createElement('div');
                    item.className = 'selected-item';
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    let valStr = card.num === 'W' ? (card.wildValue ? `*${card.wildValue}` : 'W') : `${card.num}`;
                    cardDiv.textContent = valStr;
                    item.appendChild(cardDiv);
                    if (isEntering && card.num === 'W' && !card.wildValue) {
                        const inp = document.createElement('input');
                        inp.type = 'number';
                        inp.min = 1;
                        inp.max = 9;
                        inp.className = 'wild-input';
                        inp.placeholder = '1-9';
                        inp.dataset.handIdx = handIdx;
                        inp.onchange = (e) => {
                            card.wildValue = parseInt(e.target.value);
                            this.updateUI();
                        };
                        item.appendChild(inp);
                    }
                    selCardsEl.appendChild(item);
                });
                // Sum input
                let sumArea = selEl.querySelector('#sum-input-area');
                if (!sumArea) {
                    sumArea = document.createElement('div');
                    sumArea.id = 'sum-input-area';
                    selEl.appendChild(sumArea);
                }
                sumArea.innerHTML = '<label>Sum: <input id="sum-input" type="number" min="0" max="30"></label>';
            }

            renderActionButtons() {
                const player = this.selectingPlayer;
                if (!player) return;
                const selEl = document.getElementById(`${player}-selection`);
                let btnArea = selEl.querySelector('.action-buttons');
                if (btnArea) btnArea.remove();
                btnArea = document.createElement('div');
                btnArea.className = 'action-buttons';
                selEl.appendChild(btnArea);

                if (this.phase === `selecting_${player}`) {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn btn-proceed';
                    btn.textContent = '3 Cards Selected - Enter Sum';
                    btn.disabled = this.selected[player].length !== 3;
                    btn.onclick = () => this.proceedToEnter(player);
                    btnArea.appendChild(btn);
                } else if (this.phase === `entering_${player}`) {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn btn-proceed';
                    btn.textContent = 'Submit Sum for Checking';
                    btn.onclick = () => this.submitSum();
                    btnArea.appendChild(btn);
                } else if (this.phase === `checking_${player}`) {
                    const correctBtn = document.createElement('button');
                    correctBtn.className = 'action-btn btn-correct';
                    correctBtn.textContent = 'Correct';
                    correctBtn.onclick = () => this.checkSum(true);
                    btnArea.appendChild(correctBtn);

                    const incorrectBtn = document.createElement('button');
                    incorrectBtn.className = 'action-btn btn-incorrect';
                    incorrectBtn.textContent = 'Incorrect';
                    incorrectBtn.onclick = () => this.checkSum(false);
                    btnArea.appendChild(incorrectBtn);
                }
            }

            showGameOver() {
                const p1Total = this.sheets.p1.reduce((sum, row) => sum + row.score, 0);
                const p2Total = this.sheets.p2.reduce((sum, row) => sum + row.score, 0);
                let winner = p1Total < p2Total ? 'Player 1' : (p2Total < p1Total ? 'Player 2' : 'Tie!');
                this.elements.gameOver.innerHTML = `
                    <h2>Game Over!</h2>
                    <p>Player 1 Total: ${p1Total}</p>
                    <p>Player 2 Total: ${p2Total}</p>
                    <p><strong>${winner} wins!</strong></p>
                    <p>The lowest score wins!</p>
                `;
                this.elements.gameOver.style.display = 'block';
            }
        }

        const game = new TargetTwentyGame();

        // Event listeners
        document.getElementById('new-game').onclick = () => game.newGame();
        document.getElementById('instructions-btn').onclick = () => {
            document.getElementById('modal').style.display = 'block';
        };
        document.querySelector('.close').onclick = () => {
            document.getElementById('modal').style.display = 'none';
        };
        document.getElementById('modal').onclick = (e) => {
            if (e.target === document.getElementById('modal')) {
                document.getElementById('modal').style.display = 'none';
            }
        };

        // Instructions text
        document.getElementById('instructions-text').innerHTML = `
            <h2>Work Place Guide 3E Target Twenty</h2>
            <h3>Summary</h3>
            <p>Players take turns drawing 5 cards from a deck and then each choosing three of the cards to add together to get as close as possible to 20. Players then find the difference between their score and 20. The winner is the player with the lowest score after five rounds.</p>
            <h3>Skills & Concepts</h3>
            <ul><li>Fluently add and subtract within 20 using mental strategies (2.OA.2)</li></ul>
            <h3>Materials</h3>
            <p>3 decks of Number Cards with the wild cards removed</p>
            <h2>Work Place Instructions 3E Target Twenty</h2>
            <ol>
                <li>Players need a deck of cards, 2 Target Twenty Record Sheets, and pencils.</li>
                <li>Players work together to shuffle the deck of cards, then put them in a pile face-down between them.</li>
                <li>Players take turns drawing cards from the deck until both of them have 5 cards.</li>
                <li>Players each choose three of their cards to add together. The target sum is 20, so they should choose the 3 numbers that will make a sum as close to 20 as possible, either under or over. (For example, if a player had the cards 3, 3, 4, 9, and 9, he could make 4 + 9 + 9 = 22 or 3 + 9 + 9 = 21. He would choose 3 + 9 + 9 because 21 is closer to the target, 20, than 22.)</li>
                <li>Players each write an addition equation with their numbers and their sum on the record sheet. They may use their number racks to help find the sums if they like.</li>
                <li>Players double-check each other's work.</li>
                <li>Players figure out their scores by finding the difference between their sum and 20. (For example, a sum of 16 has a score of 4; a sum of 27 has a score of 7; a sum of 20 has a score of 0.)</li>
                <li>Players each record their score and their partner's score on their record sheet.</li>
                <li>Players put the used cards face-up in a discard stack and then take turns drawing 3 new cards from the deck so they each have 5 again.</li>
                <li>Players continue taking turns until they have each played five rounds of the game.</li>
                <li>Each player adds his or her scores to determine the winner. The lowest score wins the game.</li>
            </ol>
            <h3>Game Variations</h3>
            <p>A Players use the wild cards to play the game. A wild card can be any numeral (1 to 9) they want it to be. If players use a wild card, they put a star above the numeral made from the wild card in the equation on their record sheet.</p>
        `;
    </script>
</body>
</html>